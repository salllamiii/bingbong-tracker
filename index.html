<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bing Bong Tracker ‚Äî Pev Edition</title>
  <style>
    :root{
      --bg:#0b1020; --text:#e9ecff; --muted:#aab2ff;
      --accent:#7c5cff; --accent2:#27d8a7; --warn:#ffcc66; --danger:#ff4d6d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{ margin:0; background: radial-gradient(1200px 800px at 20% 0%, #1b1f52, var(--bg));
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;}
    .wrap{ width:min(1120px, 100%); display:grid; gap:16px; grid-template-columns: 1.2fr .8fr; }
    @media (max-width: 940px){ .wrap{ grid-template-columns: 1fr; } }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10); border-radius: var(--radius);
      box-shadow: var(--shadow); padding:18px; backdrop-filter: blur(10px); }
    h1{ font-size: 26px; margin: 0 0 6px; letter-spacing:.2px; }
    h2{ font-size: 18px; margin: 16px 0 10px; }
    .sub{ color: var(--muted); margin:0 0 14px; line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ padding:8px 10px; background: rgba(124,92,255,.18); border:1px solid rgba(124,92,255,.35);
      border-radius:999px; font-size:13px; color: #efeaff; }
    .pill.ok{ background: rgba(39,216,167,.14); border-color: rgba(39,216,167,.35); }
    .pill.warn{ background: rgba(255,204,102,.14); border-color: rgba(255,204,102,.35); }
    .pill.bad{ background: rgba(255,77,109,.12); border-color: rgba(255,77,109,.35); }

    .entry{
      background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08);
      border-radius: 16px; padding:12px;
    }
    .entryTop{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .when{ color: var(--muted); font-size:12px; }
    .place{ font-weight: 900; }
    .msg{ margin: 8px 0 0; color: #eef0ff; line-height: 1.45; }

    .progressBox{ margin-top:14px; background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08);
      border-radius: 999px; overflow:hidden; height: 14px; }
    .bar{ height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px; transition: width .6s ease; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      cursor:pointer; border:0; padding:10px 12px; border-radius: 14px; color: #0b1020;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      font-weight: 800;
    }
    button.secondary{
      background: rgba(255,255,255,.10); color: var(--text); border:1px solid rgba(255,255,255,.14);
      font-weight: 700;
    }

    .banner{
      margin-top:12px;
      background: rgba(255,204,102,.12);
      border: 1px solid rgba(255,204,102,.35);
      border-radius: 16px;
      padding: 12px;
      color: #fff2cc;
      display:none;
    }
    .tiny{ font-size:12px; color: var(--muted); margin-top:10px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .timeline{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .scan{
      display:grid; grid-template-columns: 28px 1fr; gap:10px; align-items:start;
      background: rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08);
      border-radius: 16px; padding:10px 12px;
    }
    .dot{
      width: 18px; height: 18px; border-radius: 999px; margin-top:2px;
      border: 2px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      font-size:12px;
    }
    .scan.done .dot{ background: rgba(39,216,167,.18); border-color: rgba(39,216,167,.45); }
    .scan.next .dot{ background: rgba(255,204,102,.18); border-color: rgba(255,204,102,.45); }
    .scan.later .dot{ background: rgba(255,255,255,.06); }
    .scanTitle{ font-weight:900; }
    .scanMeta{ color: var(--muted); font-size:12px; margin-top:2px; }
    .scanDesc{ margin-top:6px; color: #eef0ff; line-height:1.4; }

    .footerNote{ text-align:center; color: rgba(255,255,255,.6); font-size:12px; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- MAIN -->
    <div class="card">
      <h1>üì¶ Bing Bong Tracker</h1>
      <p class="sub" id="subtitle">Loading dispatch chaos‚Ä¶</p>

      <div class="row" style="margin-bottom:8px;">
        <span class="pill ok" id="statusPill">Status: ‚Äî</span>
        <span class="pill" id="etaPill">ETA: ‚Äî</span>
        <span class="pill" id="progressPill">Progress: ‚Äî</span>
        <span class="pill warn" id="birthdayPill" style="display:none;">Birthday Alert</span>
        <span class="pill" id="trackingPill">Tracking: ‚Äî</span>
      </div>

      <div class="banner" id="birthdayBanner"></div>

      <div class="entry" style="margin-top:10px;">
        <div class="entryTop">
          <div class="place" id="currentPlace">Current stop: ‚Äî</div>
          <div class="when" id="countdown">‚Äî</div>
        </div>
        <p class="msg" id="currentMsg">‚Äî</p>
        <div class="progressBox" aria-label="progress">
          <div class="bar" id="bar"></div>
        </div>
        <div class="tiny" id="routeLine">Route: ‚Äî</div>
      </div>

      <div class="btns">
        <button class="secondary" id="waShareBtn">Share to Pev (WhatsApp)</button>
        <button class="secondary" id="refreshBtn">Refresh Scans</button>
      </div>

      <h2>üõ∞Ô∏è Scan Events (Absolutely Real)</h2>
      <p class="sub">Courier scans + island survival scans. Bing Bong is doing logistics and cardio.</p>
      <div class="timeline" id="timeline"></div>

      <div class="footerNote">
        100% chaotic scout energy. 0% legal parcel tracking.
      </div>
    </div>

    <!-- SIDE -->
    <div class="card">
      <h2>üìå How this works</h2>
      <p class="sub">
        This tracker reads updates from <span class="mono">data.json</span>. When the dispatcher (you) edits that file on GitHub,
        Pev sees new scans at the same link.
      </p>
      <div class="entry">
        <div class="place">Dispatcher Notes</div>
        <p class="msg">
          If changes don‚Äôt show immediately: refresh once or twice (sometimes browsers cache). Worst case: hard refresh.
        </p>
      </div>
      <div class="entry" style="margin-top:12px;">
        <div class="place">Suggested next scan</div>
        <p class="msg" id="suggestion">Loading suggestion‚Ä¶</p>
      </div>
      <div class="tiny" id="loadedAt"></div>
    </div>

  </div>

<script>
const el = (id) => document.getElementById(id);

function isoToday(){
  const d = new Date(); d.setHours(12,0,0,0);
  return d.toISOString().slice(0,10);
}
function dateFromISO(iso){
  if(!iso) return null;
  const d = new Date(iso + "T12:00:00");
  return isNaN(d) ? null : d;
}
function niceDate(iso){
  const d = dateFromISO(iso);
  if(!d) return "‚Äî";
  return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
}
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function daysBetween(a,b){
  const ms = (b - a);
  return Math.round(ms / (1000*60*60*24));
}
function addDaysISO(iso, days){
  const d = dateFromISO(iso);
  if(!d) return "";
  d.setDate(d.getDate() + Number(days||0));
  return d.toISOString().slice(0,10);
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

// Fake tracking number (stable)
function fnv1a(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
  }
  return h >>> 0;
}
function makeTrackingNumber(data){
  const base = `${data.friendName}|${data.birthdayDate}|${data.shipmentDate}|${data.deliveryWindowDays}|BB`;
  const h = fnv1a(base).toString(16).toUpperCase().padStart(8,"0");
  const y = (data.birthdayDate || "2026-01-29").slice(2,4);
  const m = (data.birthdayDate || "2026-01-29").slice(5,7);
  const name = (data.friendName||"PEV").replace(/[^A-Za-z0-9]/g,"").slice(0,6).toUpperCase();
  const prefix = (data.trackingPrefix || "BB").replace(/[^A-Za-z0-9]/g,"").slice(0,3).toUpperCase();
  return `${prefix}-${name}-${y}${m}-${h}`;
}

function effectiveArrivalISO(d){
  if(d.arrivalDate) return d.arrivalDate;
  if(d.shipmentDate && d.deliveryWindowDays){
    return addDaysISO(d.shipmentDate, Number(d.deliveryWindowDays));
  }
  return "";
}

async function loadData(){
  // Cache-bust so edits show quicker on GitHub Pages
  const res = await fetch(`./data.json?v=${Date.now()}`, { cache: "no-store" });
  if(!res.ok) throw new Error("Could not load data.json");
  return await res.json();
}

function computeProgress(d){
  const now = new Date();
  const start = dateFromISO(d.orderDate) || dateFromISO(d.shipmentDate) || new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const arrivalISO = effectiveArrivalISO(d) || addDaysISO(d.shipmentDate || isoToday(), d.deliveryWindowDays || 10);
  const end = dateFromISO(arrivalISO) || new Date(start.getTime() + 30*24*3600*1000);

  const total = Math.max(1, end - start);
  const done = clamp(now - start, 0, total);
  const pct = clamp(done / total, 0, 1);

  const ship = dateFromISO(d.shipmentDate);
  const delivered = now >= end;
  const preShip = ship && now < ship;

  const stages = (d.checkpoints || []).length || 1;
  let stageIndex = clamp(Math.floor(pct * (stages - 1)), 0, stages - 1);
  if(preShip) stageIndex = clamp(Math.floor(pct * 3), 0, Math.min(2, stages - 1));
  if(delivered) stageIndex = stages - 1;

  return { now, start, end, pct, stageIndex, arrivalISO, delivered, preShip };
}

function renderTimeline(d, now){
  const box = el("timeline");
  box.innerHTML = "";

  const scans = Array.isArray(d.scans) ? d.scans.slice().sort((a,b)=>{
    const ta = dateFromISO(a.whenISO)?.getTime() ?? 0;
    const tb = dateFromISO(b.whenISO)?.getTime() ?? 0;
    return ta - tb;
  }) : [];

  const nextIndex = scans.findIndex(s => {
    const t = dateFromISO(s.whenISO);
    return t && t > now;
  });

  scans.forEach((s, idx) => {
    const t = dateFromISO(s.whenISO);
    const done = t ? (t <= now) : false;
    const isNext = (idx === nextIndex);
    const cls = done ? "scan done" : (isNext ? "scan next" : "scan later");
    const icon = done ? "‚úì" : (isNext ? "!" : "‚Ä¢");

    const div = document.createElement("div");
    div.className = cls;
    div.innerHTML = `
      <div class="dot">${icon}</div>
      <div>
        <div class="scanTitle">${escapeHtml(s.title || "SCAN")}</div>
        <div class="scanMeta">${escapeHtml(s.loc || "Unknown")} ‚Ä¢ ${escapeHtml(t ? niceDate(s.whenISO) : "Unknown time")}</div>
        <div class="scanDesc">${escapeHtml(s.desc || "")}</div>
      </div>
    `;
    box.appendChild(div);
  });

  // Suggest the next funny scan based on ‚ÄúnextIndex‚Äù
  const suggestion = [
    "‚ÄúCUSTOMS CHECK: Bing Bong declared himself ‚ÄòHead Scout‚Äô and attempted to loot a stamp.‚Äù",
    "‚ÄúSORTING FACILITY: Bing Bong got stuck on a conveyor belt and called it cardio.‚Äù",
    "‚ÄúROUTE UPDATE: Bing Bong insisted the fastest path is straight up (again).‚Äù",
    "‚ÄúFIELD REPORT: Bing Bong discovered bubble wrap and entered his villain era.‚Äù"
  ];
  el("suggestion").textContent = nextIndex >= 0
    ? `Next scan idea: ${suggestion[nextIndex % suggestion.length]}`
    : `Next scan idea: ‚ÄúFINAL BOSS: Pev‚Äôs front door. Bing Bong is approaching at maximum plush velocity.‚Äù`;
}

function render(d){
  const { now, pct, stageIndex, arrivalISO, delivered, preShip } = computeProgress(d);

  el("subtitle").textContent =
    `Mission: deliver Bing Bong to ${d.friendName || "Pev"}. Birthday: ${niceDate(d.birthdayDate)}.`;

  const tn = makeTrackingNumber(d);
  el("trackingPill").textContent = `Tracking: ${tn}`;

  el("etaPill").textContent = arrivalISO
    ? `ETA: ${niceDate(arrivalISO)}${d.arrivalDate ? " (manual)" : " (est.)"}`
    : `ETA: Unknown (Bing Bong is ‚Äúfreestyling‚Äù)`;

  const pct100 = Math.round(pct * 100);
  el("progressPill").textContent = `Progress: ${pct100}%`;
  el("bar").style.width = `${pct100}%`;

  let status = "In Transit";
  let cls = "pill ok";
  if(preShip){ status = "Preparing for Dispatch"; cls = "pill warn"; }
  if(delivered){ status = "Delivered ‚úÖ"; cls = "pill ok"; }
  el("statusPill").textContent = `Status: ${status}`;
  el("statusPill").className = cls;

  // countdown
  let countdown = "‚Äî";
  if(arrivalISO){
    const diff = daysBetween(now, dateFromISO(arrivalISO));
    if(diff > 0) countdown = `${diff} day(s) until arrival`;
    else if(diff === 0) countdown = `Arrival day!`;
    else countdown = `Arrived ${Math.abs(diff)} day(s) ago`;
  } else if(d.shipmentDate){
    const ship = dateFromISO(d.shipmentDate);
    const ds = daysBetween(now, ship);
    countdown = ds > 0 ? `${ds} day(s) until shipment` : (ds === 0 ? "Ships today (allegedly)" : `Shipped ${Math.abs(ds)} day(s) ago`);
  }
  el("countdown").textContent = countdown;

  // birthday banner if late
  const bday = dateFromISO(d.birthdayDate);
  const banner = el("birthdayBanner");
  const pill = el("birthdayPill");
  if(bday && arrivalISO){
    const arrival = dateFromISO(arrivalISO);
    const late = arrival && arrival > bday;
    if(late){
      pill.style.display = "";
      banner.style.display = "";
      const diff = daysBetween(now, bday);
      if(diff > 0){
        banner.textContent = `‚ö†Ô∏è Birthday in ${diff} day(s). Bing Bong is sending emergency birthday vibes from a mysterious island and insists this counts as ‚Äútracking progress.‚Äù`;
      } else if(diff === 0){
        banner.textContent = `üéÇ It‚Äôs Pev‚Äôs birthday TODAY. Bing Bong performed a ceremonial squeak and promised he‚Äôs ‚Äúbasically arriving spiritually.‚Äù`;
      } else {
        banner.textContent = `üò≠ Bing Bong is late by ${Math.abs(diff)} day(s). He claims the island is ‚Äúlogistically complicated‚Äù and ‚Äúfull of cardio.‚Äù`;
      }
    } else {
      pill.style.display = "none";
      banner.style.display = "none";
    }
  }

  const cp = (d.checkpoints || [])[stageIndex] || { name: "Somewhere Vertical", msg: "Bing Bong is progressing‚Ä¶ emotionally." };
  el("currentPlace").textContent = `Current stop: ${cp.name}`;
  el("currentMsg").textContent = cp.msg;
  el("routeLine").textContent = `Route: ${(d.checkpoints||[]).map(x=>x.name).join(" ‚Üí ")}`;

  renderTimeline(d, now);

  el("loadedAt").textContent = `Last loaded: ${new Date().toLocaleString()}`;
}

function wireButtons(currentData){
  el("refreshBtn").onclick = async () => {
    try{
      const d = await loadData();
      render(d);
      wireButtons(d);
    }catch(e){
      alert("Could not refresh. If you just edited data.json, try again in a moment.");
    }
  };

  el("waShareBtn").onclick = () => {
    const d = currentData;
    const tn = makeTrackingNumber(d);
    const link = location.href.split("#")[0]; // keep it clean
    const text =
      `üö® BING BONG TRACKER üö®\n\n` +
      `Tracking: ${tn}\n` +
      `Recipient: ${d.friendName || "Pev"}\n` +
      `${el("statusPill").textContent}\n` +
      `${el("etaPill").textContent}\n\n` +
      `Live feed (totally official): ${link}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
  };
}

// Boot
(async () => {
  try{
    const d = await loadData();
    render(d);
    wireButtons(d);
  }catch(e){
    el("subtitle").textContent = "Couldn‚Äôt load data.json üò≠";
    el("currentMsg").textContent =
      "If you‚Äôre seeing this on GitHub Pages, make sure BOTH files exist in the repo root: index.html and data.json.";
  }
})();
</script>
</body>
</html>
