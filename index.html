<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bing Bong Tracker ‚Äî Pev Edition</title>
  <style>
    :root{
      --bg:#0b1020; --text:#e9ecff; --muted:#aab2ff;
      --accent:#7c5cff; --accent2:#27d8a7; --warn:#ffcc66;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{ margin:0; background: radial-gradient(1200px 800px at 20% 0%, #1b1f52, var(--bg));
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;}
    .wrap{ width:min(1120px, 100%); display:grid; gap:16px; grid-template-columns: 1.2fr .8fr; }
    @media (max-width: 940px){ .wrap{ grid-template-columns: 1fr; } }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10); border-radius: var(--radius);
      box-shadow: var(--shadow); padding:18px; backdrop-filter: blur(10px); }
    h1{ font-size: 26px; margin: 0 0 6px; letter-spacing:.2px; }
    h2{ font-size: 18px; margin: 16px 0 10px; }
    .sub{ color: var(--muted); margin:0 0 14px; line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ padding:8px 10px; background: rgba(124,92,255,.18); border:1px solid rgba(124,92,255,.35);
      border-radius:999px; font-size:13px; color: #efeaff; }
    .pill.ok{ background: rgba(39,216,167,.14); border-color: rgba(39,216,167,.35); }
    .pill.warn{ background: rgba(255,204,102,.14); border-color: rgba(255,204,102,.35); }

    .banner{
      margin-top:12px; background: rgba(255,204,102,.12); border: 1px solid rgba(255,204,102,.35);
      border-radius: 16px; padding: 12px; color: #fff2cc; display:none;
    }
    .entry{
      background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08);
      border-radius: 16px; padding:12px;
    }
    .entryTop{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .when{ color: var(--muted); font-size:12px; }
    .place{ font-weight: 900; }
    .msg{ margin: 8px 0 0; color: #eef0ff; line-height: 1.45; }

    .progressBox{ margin-top:14px; background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08);
      border-radius: 999px; overflow:hidden; height: 14px; }
    .bar{ height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px; transition: width .6s ease; }
    /* Mystery bar animation for ???% */
    .bar.unknown{
      width: 65% !important;
      background: linear-gradient(90deg, rgba(255,255,255,.15), rgba(124,92,255,.35), rgba(39,216,167,.25), rgba(255,255,255,.12));
      background-size: 240% 100%;
      animation: shimmer 2.3s linear infinite;
    }
    @keyframes shimmer{
      0%{ background-position: 0% 50%; }
      100%{ background-position: 240% 50%; }
    }

    .timeline{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .scan{
      display:grid; grid-template-columns: 28px 1fr; gap:10px; align-items:start;
      background: rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08);
      border-radius: 16px; padding:10px 12px;
    }
    .dot{
      width: 18px; height: 18px; border-radius: 999px; margin-top:2px;
      border: 2px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center; font-size:12px;
      background: rgba(39,216,167,.18); border-color: rgba(39,216,167,.45);
    }
    .scanTitle{ font-weight:900; }
    .scanMeta{ color: var(--muted); font-size:12px; margin-top:2px; }
    .scanDesc{ margin-top:6px; color: #eef0ff; line-height:1.4; }

    .tiny{ font-size:12px; color: var(--muted); margin-top:10px; }
    .footerNote{ text-align:center; color: rgba(255,255,255,.6); font-size:12px; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- MAIN -->
    <div class="card">
      <h1>üì¶ Bing Bong Tracker</h1>
      <p class="sub" id="subtitle">Loading dispatch chaos‚Ä¶</p>

      <div class="row" style="margin-bottom:8px;">
        <span class="pill ok" id="statusPill">Status: ‚Äî</span>
        <span class="pill" id="etaPill">ETA: ‚Äî</span>
        <span class="pill" id="progressPill">Progress: ‚Äî</span>
        <span class="pill warn" id="birthdayPill" style="display:none;">Birthday Alert</span>
        <span class="pill" id="trackingPill">Tracking: ‚Äî</span>
      </div>

      <div class="banner" id="birthdayBanner"></div>

      <div class="entry" style="margin-top:10px;">
        <div class="entryTop">
          <div class="place" id="currentPlace">Latest scan: ‚Äî</div>
          <div class="when" id="countdown">‚Äî</div>
        </div>
        <p class="msg" id="currentMsg">‚Äî</p>
        <div class="progressBox" aria-label="progress">
          <div class="bar" id="bar"></div>
        </div>
        <div class="tiny" id="spoilerSafeHint">Bing Bong is surviving in real time.</div>
      </div>

      <h2>üõ∞Ô∏è Scan History</h2>
      <div class="timeline" id="timeline"></div>

      <div class="footerNote">
        100% chaotic scout energy. 0% legally binding parcel tracking.
      </div>
    </div>

    <!-- RIGHT PANEL: DAILY UPDATE -->
    <div class="card">
      <h2>üóûÔ∏è Daily Bing Bong Report</h2>
      <p class="sub" id="dailyMeta">Loading today‚Äôs report‚Ä¶</p>
      <div class="entry">
        <div class="place" id="dailyTitle">Today:</div>
        <p class="msg" id="dailyMsg">‚Äî</p>
      </div>
      <div class="tiny" id="dailyFoot">One report per day. All thanks to Marcin's psychic abilities.</div>
    </div>
  </div>

<script>
const el = (id) => document.getElementById(id);

function isoToday(){
  const d = new Date(); d.setHours(12,0,0,0);
  return d.toISOString().slice(0,10);
}
function dateFromISO(iso){
  if(!iso) return null;
  const d = new Date(iso + "T12:00:00");
  return isNaN(d) ? null : d;
}
function niceDate(iso){
  const d = dateFromISO(iso);
  if(!d) return "‚Äî";
  return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
}
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function daysBetween(a,b){
  const ms = (b - a);
  return Math.round(ms / (1000*60*60*24));
}
function addDaysISO(iso, days){
  const d = dateFromISO(iso);
  if(!d) return "";
  d.setDate(d.getDate() + Number(days||0));
  return d.toISOString().slice(0,10);
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

// stable fake tracking number
function fnv1a(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
  }
  return h >>> 0;
}
function makeTrackingNumber(data){
  const base = `${data.friendName}|${data.birthdayDate}|${data.shipmentDate}|${data.deliveryWindowDays}|BB`;
  const h = fnv1a(base).toString(16).toUpperCase().padStart(8,"0");
  const y = (data.birthdayDate || "2026-01-29").slice(2,4);
  const m = (data.birthdayDate || "2026-01-29").slice(5,7);
  const name = (data.friendName||"PEV").replace(/[^A-Za-z0-9]/g,"").slice(0,6).toUpperCase();
  const prefix = (data.trackingPrefix || "BB").replace(/[^A-Za-z0-9]/g,"").slice(0,3).toUpperCase();
  return `${prefix}-${name}-${y}${m}-${h}`;
}

function effectiveArrivalISO(d){
  if(d.arrivalDate) return d.arrivalDate;
  if(d.shipmentDate && d.deliveryWindowDays){
    return addDaysISO(d.shipmentDate, Number(d.deliveryWindowDays));
  }
  return "";
}

async function loadData(){
  const res = await fetch(`./data.json?v=${Date.now()}`, { cache: "no-store" });
  if(!res.ok) throw new Error("Could not load data.json");
  return await res.json();
}

function computeProgressDefault(d){
  // fallback only (we will override with scan-specific progress rules)
  const now = new Date();
  const start = dateFromISO(d.orderDate) || dateFromISO(d.shipmentDate) || new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const arrivalISO = effectiveArrivalISO(d) || addDaysISO(d.shipmentDate || isoToday(), d.deliveryWindowDays || 10);
  const end = dateFromISO(arrivalISO) || new Date(start.getTime() + 30*24*3600*1000);

  const total = Math.max(1, end - start);
  const done = clamp(now - start, 0, total);
  const pct = clamp(done / total, 0, 1);
  return { now, arrivalISO, pct };
}

function scansThatHaveHappened(d, now){
  const scans = Array.isArray(d.scans) ? d.scans.slice() : [];
  return scans
    .filter(s => {
      const t = dateFromISO(s.whenISO);
      return t && t <= now;
    })
    .sort((a,b) => (dateFromISO(a.whenISO) - dateFromISO(b.whenISO)));
}

function scanDisplayDate(s){
  if(s.whenLabel && String(s.whenLabel).trim()) return s.whenLabel;
  return niceDate(s.whenISO);
}

function renderTimeline(pastScans){
  const box = el("timeline");
  box.innerHTML = "";

  if(pastScans.length === 0){
    box.innerHTML = `
      <div class="entry">
        <div class="place">No scans yet</div>
        <p class="msg">Bing Bong is currently off-grid, gathering supplies and emotional resilience.</p>
      </div>
    `;
    return;
  }

  // newest first
  pastScans.slice().reverse().forEach(s => {
    const div = document.createElement("div");
    div.className = "scan";
    div.innerHTML = `
      <div class="dot">‚úì</div>
      <div>
        <div class="scanTitle">${escapeHtml(s.title || "SCAN")}</div>
        <div class="scanMeta">${escapeHtml(s.loc || "Unknown")} ‚Ä¢ ${escapeHtml(scanDisplayDate(s))}</div>
        <div class="scanDesc">${escapeHtml(s.desc || "")}</div>
      </div>
    `;
    box.appendChild(div);
  });
}

// Deterministic daily randomness (so it changes daily but doesn‚Äôt ‚Äújump‚Äù on refresh)
function hashStr(str){
  let h = 2166136261 >>> 0;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function dailyRandomInt(seedStr, min, max){
  const h = hashStr(seedStr);
  const span = (max - min + 1);
  return min + (h % span);
}
function pickDaily(pool, seedStr){
  if(!pool || pool.length === 0) return "Bing Bong is currently buffering.";
  const idx = dailyRandomInt(seedStr, 0, pool.length - 1);
  return pool[idx];
}
function pseudoRandomTime(seedStr){
  // 08:05‚Äì21:55
  const hh = dailyRandomInt(seedStr + "|h", 8, 21);
  const mm = dailyRandomInt(seedStr + "|m", 0, 11) * 5;
  const pad = (n) => String(n).padStart(2,"0");
  return `${pad(hh)}:${pad(mm)}`;
}

function stageKeyFromLatestScan(latestScan){
  return (latestScan && latestScan.stageKey) ? String(latestScan.stageKey) : "unknown";
}

function applyProgressFromScan(latestScan, d){
  const bar = el("bar");

  // defaults
  let label = "Progress: ‚Äî";
  let barMode = "fixed";
  let pct100 = 0;

  if(latestScan && latestScan.progressMode){
    const mode = String(latestScan.progressMode);
    if(mode === "fixed"){
      pct100 = clamp(Number(latestScan.progressValue ?? 0), 0, 100);
      label = `Progress: ${pct100}%`;
      barMode = "fixed";
    } else if(mode === "unknown"){
      label = `Progress: ???%`;
      barMode = "unknown";
    }
  } else {
    // fallback
    const { pct } = computeProgressDefault(d);
    pct100 = Math.round(pct * 100);
    label = `Progress: ${pct100}%`;
    barMode = "fixed";
  }

  el("progressPill").textContent = label;

  // render bar
  bar.classList.remove("unknown");
  if(barMode === "unknown"){
    bar.classList.add("unknown");
  } else {
    bar.style.width = `${pct100}%`;
  }
}

function renderDailyUpdate(d, stageKey, todayISO, latestScan){
  const pools = d.dailyUpdatePools || {};
  const pool = pools[stageKey] || pools["unknown"] || [];
  const seed = `${todayISO}|${stageKey}|${d.friendName || ""}|bingbong`;
  const time = pseudoRandomTime(seed);

  const msg = pickDaily(pool, seed);
  const where = latestScan ? (latestScan.loc || latestScan.title || "Somewhere") : "Somewhere off-grid";

  el("dailyMeta").textContent = `Posted at ${time} ‚Ä¢ Location: ${where}`;
  el("dailyTitle").textContent = `Today (${niceDate(todayISO)}):`;
  el("dailyMsg").textContent = msg;
}

function render(d){
  const now = new Date();
  const todayISO = isoToday();
  const past = scansThatHaveHappened(d, now);

  el("subtitle").textContent =
    `Mission: deliver Bing Bong to ${d.friendName || "Pev"}. Birthday: ${niceDate(d.birthdayDate)}.`;

  el("trackingPill").textContent = `Tracking: ${makeTrackingNumber(d)}`;

  const arrivalISO = effectiveArrivalISO(d);
  el("etaPill").textContent = arrivalISO
    ? `ETA: ${niceDate(arrivalISO)}${d.arrivalDate ? " (manual)" : " (est.)"}`
    : `ETA: Unknown (Bing Bong is ‚Äúfreestyling‚Äù)`;

  // status + countdown
  const arrival = arrivalISO ? dateFromISO(arrivalISO) : null;
  const ship = d.shipmentDate ? dateFromISO(d.shipmentDate) : null;

  let countdown = "‚Äî";
  if(arrival){
    const diff = daysBetween(now, arrival);
    countdown = diff > 0 ? `${diff} day(s) until arrival` : (diff === 0 ? "Arrival day!" : `Arrived ${Math.abs(diff)} day(s) ago`);
  } else if(ship){
    const ds = daysBetween(now, ship);
    countdown = ds > 0 ? `${ds} day(s) until shipment` : (ds === 0 ? "Ships today (allegedly)" : `Shipped ${Math.abs(ds)} day(s) ago`);
  }
  el("countdown").textContent = "ETA: maybe soon, maybe no";

  const delivered = arrival ? (now >= arrival) : false;
  const preShip = ship ? (now < ship) : false;

  el("statusPill").textContent = `Status: ${delivered ? "Delivered ‚úÖ" : (preShip ? "Preparing for Dispatch" : "In Transit")}`;
  el("statusPill").className = delivered ? "pill ok" : (preShip ? "pill warn" : "pill ok");

  // birthday banner if late
  const bday = dateFromISO(d.birthdayDate);
  const banner = el("birthdayBanner");
  const pill = el("birthdayPill");
  if(bday && arrival){
    const late = arrival > bday;
    if(late){
      pill.style.display = "";
      banner.style.display = "";
      const diff = daysBetween(now, bday);
      banner.textContent =
        diff > 0 ? `‚ö†Ô∏è Birthday in ${diff} day(s). Bing Bong is sending emergency birthday vibes from a mysterious island.`
        : diff === 0 ? `üéÇ It‚Äôs Pev‚Äôs birthday TODAY. Bing Bong performed a ceremonial squeak and promised he‚Äôs ‚Äúbasically arriving spiritually.‚Äù`
        : `üò≠ Bing Bong is late by ${Math.abs(diff)} day(s). He claims the island is ‚Äúlogistically complicated‚Äù and ‚Äúfull of cardio.‚Äù`;
    } else {
      pill.style.display = "none";
      banner.style.display = "none";
    }
  } else {
    pill.style.display = "none";
    banner.style.display = "none";
  }

  // latest scan display + progress override
  if(past.length > 0){
    const latest = past[past.length - 1];
    el("currentPlace").textContent = `Latest scan: ${latest.title || "SCAN"}`;
    el("currentMsg").textContent = `${latest.loc || "Unknown"} ‚Äî ${scanDisplayDate(latest)}. ${latest.desc || ""}`;

    applyProgressFromScan(latest, d);

    // daily update (stage-relevant)
    const stageKey = stageKeyFromLatestScan(latest);
    renderDailyUpdate(d, stageKey, todayISO, latest);
  } else {
    el("currentPlace").textContent = "Latest scan: Pending";
    el("currentMsg").textContent = "Bing Bong is currently off-grid, gathering supplies and emotional resilience.";

    // progress fallback
    el("progressPill").textContent = "Progress: 0%";
    el("bar").classList.remove("unknown");
    el("bar").style.width = "0%";

    renderDailyUpdate(d, "unknown", todayISO, null);
  }

  renderTimeline(past);
}

// Boot
(async () => {
  try{
    const d = await loadData();
    render(d);
  }catch(e){
    el("subtitle").textContent = "Couldn‚Äôt load data.json üò≠";
    el("currentMsg").textContent =
      "If you‚Äôre seeing this on GitHub Pages, make sure data.json exists in the repo root alongside index.html.";
  }
})();
</script>
</body>
</html>
