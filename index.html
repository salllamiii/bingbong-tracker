<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bing Bong Tracker ‚Äî Pev Edition</title>
  <style>
    :root{
      --bg:#0b1020; --text:#e9ecff; --muted:#aab2ff;
      --accent:#7c5cff; --accent2:#27d8a7; --warn:#ffcc66;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{ margin:0; background: radial-gradient(1200px 800px at 20% 0%, #1b1f52, var(--bg));
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;}
    .wrap{ width:min(1120px, 100%); display:grid; gap:16px; grid-template-columns: 1.2fr .8fr; }
    @media (max-width: 940px){ .wrap{ grid-template-columns: 1fr; } }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10); border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35); padding:18px; backdrop-filter: blur(10px); }
    h1{ font-size: 26px; margin: 0 0 6px; letter-spacing:.2px; }
    h2{ font-size: 18px; margin: 16px 0 10px; }
    .sub{ color: var(--muted); margin:0 0 14px; line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ padding:8px 10px; background: rgba(124,92,255,.18); border:1px solid rgba(124,92,255,.35);
      border-radius:999px; font-size:13px; color: #efeaff; }
    .pill.ok{ background: rgba(39,216,167,.14); border-color: rgba(39,216,167,.35); }
    .pill.warn{ background: rgba(255,204,102,.14); border-color: rgba(255,204,102,.35); }

    .banner{ margin-top:12px; background: rgba(255,204,102,.12); border: 1px solid rgba(255,204,102,.35);
      border-radius: 16px; padding: 12px; color: #fff2cc; display:none; }
    .entry{ background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08);
      border-radius: 16px; padding:12px; }
    .entryTop{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .when{ color: var(--muted); font-size:12px; }
    .place{ font-weight: 900; }
    .msg{ margin: 8px 0 0; color: #eef0ff; line-height: 1.45; }

    .progressBox{ margin-top:14px; background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08);
      border-radius: 999px; overflow:hidden; height: 14px; }
    .bar{ height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px; transition: width .6s ease; }
    .bar.unknown{
      width: 65% !important;
      background: linear-gradient(90deg, rgba(255,255,255,.15), rgba(124,92,255,.35), rgba(39,216,167,.25), rgba(255,255,255,.12));
      background-size: 240% 100%;
      animation: shimmer 2.3s linear infinite;
    }
    @keyframes shimmer{
      0%{ background-position: 0% 50%; }
      100%{ background-position: 240% 50%; }
    }

    .timeline{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .scan{ display:grid; grid-template-columns: 28px 1fr; gap:10px; align-items:start;
      background: rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08);
      border-radius: 16px; padding:10px 12px; }
    .dot{ width: 18px; height: 18px; border-radius: 999px; margin-top:2px;
      border: 2px solid rgba(255,255,255,.18); display:flex; align-items:center; justify-content:center; font-size:12px;
      background: rgba(39,216,167,.18); border-color: rgba(39,216,167,.45); }
    .scanTitle{ font-weight:900; }
    .scanMeta{ color: var(--muted); font-size:12px; margin-top:2px; }
    .scanDesc{ margin-top:6px; color: #eef0ff; line-height:1.4; }
    .tiny{ font-size:12px; color: var(--muted); margin-top:10px; }
    .footerNote{ text-align:center; color: rgba(255,255,255,.6); font-size:12px; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üì¶ Bing Bong Tracker</h1>
      <p class="sub" id="subtitle">Loading dispatch chaos‚Ä¶</p>

      <div class="row" style="margin-bottom:8px;">
        <span class="pill ok" id="statusPill">Status: ‚Äî</span>
        <span class="pill" id="etaPill">ETA: ‚Äî</span>
        <span class="pill" id="progressPill">Progress: ‚Äî</span>
        <span class="pill warn" id="birthdayPill" style="display:none;">Birthday Alert</span>
        <span class="pill" id="trackingPill">Tracking: ‚Äî</span>
      </div>

      <div class="banner" id="birthdayBanner"></div>

      <div class="entry" style="margin-top:10px;">
        <div class="entryTop">
          <div class="place" id="currentPlace">Latest scan: ‚Äî</div>
          <div class="when" id="countdown"></div>
        </div>
        <p class="msg" id="currentMsg">‚Äî</p>
        <div class="progressBox" aria-label="progress">
          <div class="bar" id="bar"></div>
        </div>
        <div class="tiny" id="spoilerSafeHint">Bing Bong is surviving in real time.</div>
      </div>

      <h2>üõ∞Ô∏è Scan History</h2>
      <div class="timeline" id="timeline"></div>

      <div class="footerNote">
        100% chaotic scout energy. 0% legally binding parcel tracking.
      </div>
    </div>

    <div class="card">
      <h2>üóûÔ∏è Daily Bing Bong Report</h2>
      <p class="sub" id="dailyMeta">Loading today‚Äôs report‚Ä¶</p>
      <div class="entry">
        <div class="place" id="dailyTitle">Today:</div>
        <p class="msg" id="dailyMsg">‚Äî</p>
      </div>
      <div class="tiny" id="dailyFoot">One report per day. Time is ‚Äúrandom‚Äù because Bing Bong refuses schedules.</div>
    </div>
  </div>

<script>
const el = (id) => document.getElementById(id);

function dateFromISO(iso){
  if(!iso) return null;
  const d = new Date(iso + "T12:00:00");
  return isNaN(d) ? null : d;
}
function niceDate(iso){
  const d = dateFromISO(iso);
  if(!d) return "‚Äî";
  return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
}
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function getUKNowParts(){
  const parts = new Intl.DateTimeFormat("en-GB", {
    timeZone: "Europe/London",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  }).formatToParts(new Date());

  const map = {};
  for (const p of parts) map[p.type] = p.value;

  return { y:+map.year, m:+map.month, d:+map.day, hh:+map.hour, mm:+map.minute };
}
function ukISODate(){
  const p = getUKNowParts();
  const pad = (n) => String(n).padStart(2, "0");
  return `${p.y}-${pad(p.m)}-${pad(p.d)}`;
}
function timeToMinutes(t){
  const [h, m] = String(t || "00:00").split(":").map(Number);
  return (Number.isFinite(h) ? h : 0) * 60 + (Number.isFinite(m) ? m : 0);
}

function fnv1a(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
  }
  return h >>> 0;
}
function makeTrackingNumber(data){
  const base = `${data.friendName}|${data.birthdayDate}|${data.shipmentDate}|${data.deliveryWindowDays}|BB`;
  const h = fnv1a(base).toString(16).toUpperCase().padStart(8,"0");
  const y = (data.birthdayDate || "2026-01-29").slice(2,4);
  const m = (data.birthdayDate || "2026-01-29").slice(5,7);
  const name = (data.friendName||"PEV").replace(/[^A-Za-z0-9]/g,"").slice(0,6).toUpperCase();
  const prefix = (data.trackingPrefix || "BB").replace(/[^A-Za-z0-9]/g,"").slice(0,3).toUpperCase();
  return `${prefix}-${name}-${y}${m}-${h}`;
}

async function loadData(){
  const res = await fetch(`./data.json?v=${Date.now()}`, { cache: "no-store" });
  if(!res.ok) throw new Error("Could not load data.json");
  return await res.json();
}

function scanDisplayDate(s){
  if(s.whenLabel && String(s.whenLabel).trim()) return s.whenLabel;
  return niceDate(s.whenISO);
}

function scansThatHaveHappened(d){
  const scans = Array.isArray(d.scans) ? d.scans.slice() : [];
  const todayUK = ukISODate();
  const nowUK = getUKNowParts();
  const nowMin = nowUK.hh * 60 + nowUK.mm;

  return scans
    .filter(s => {
      if (!s.whenISO) return false;
      if (s.whenISO < todayUK) return true;
      if (s.whenISO > todayUK) return false;
      return nowMin >= timeToMinutes(s.whenTime);
    })
    .sort((a,b) => {
      const da = dateFromISO(a.whenISO) - dateFromISO(b.whenISO);
      if (da !== 0) return da;
      return Number(a.order ?? 0) - Number(b.order ?? 0);
    });
}

function renderTimeline(pastScans){
  const box = el("timeline");
  box.innerHTML = "";

  if(pastScans.length === 0){
    box.innerHTML = `
      <div class="entry">
        <div class="place">No scans yet</div>
        <p class="msg">Bing Bong is currently off-grid, gathering supplies and emotional resilience.</p>
      </div>
    `;
    return;
  }

  pastScans.slice().reverse().forEach(s => {
    const div = document.createElement("div");
    div.className = "scan";
    div.innerHTML = `
      <div class="dot">‚úì</div>
      <div>
        <div class="scanTitle">${escapeHtml(s.title || "SCAN")}</div>
        <div class="scanMeta">${escapeHtml(s.loc || "Unknown")} ‚Ä¢ ${escapeHtml(scanDisplayDate(s))}</div>
        <div class="scanDesc">${escapeHtml(s.desc || "")}</div>
      </div>
    `;
    box.appendChild(div);
  });
}

// Deterministic daily randomness
function hashStr(str){
  let h = 2166136261 >>> 0;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function dailyRandomInt(seedStr, min, max){
  const h = hashStr(seedStr);
  const span = (max - min + 1);
  return min + (h % span);
}
function pickDaily(pool, seedStr){
  if(!pool || pool.length === 0) return "Bing Bong is currently buffering.";
  return pool[dailyRandomInt(seedStr, 0, pool.length - 1)];
}
function pseudoRandomTime(seedStr){
  const hh = dailyRandomInt(seedStr + "|h", 8, 21);
  const mm = dailyRandomInt(seedStr + "|m", 0, 11) * 5;
  const pad = (n) => String(n).padStart(2,"0");
  return `${pad(hh)}:${pad(mm)}`;
}
function stageKeyFromLatestScan(latestScan){
  return (latestScan && latestScan.stageKey) ? String(latestScan.stageKey) : "unknown";
}
function renderDailyUpdate(d, stageKey, todayISO, latestScan){
  const pools = d.dailyUpdatePools || {};
  const pool = pools[stageKey] || pools["unknown"] || [];
  const seed = `${todayISO}|${stageKey}|${d.friendName || ""}|bingbong`;
  const time = pseudoRandomTime(seed);
  const msg = pickDaily(pool, seed);
  const where = latestScan ? (latestScan.loc || latestScan.title || "Somewhere") : "Somewhere off-grid";

  el("dailyMeta").textContent = `Posted at ${time} ‚Ä¢ Location: ${where}`;
  el("dailyTitle").textContent = `Today (${niceDate(todayISO)}):`;
  el("dailyMsg").textContent = msg;
}

function applyProgressFromScan(latestScan){
  const bar = el("bar");
  let label = "Progress: ‚Äî";
  let barMode = "fixed";
  let pct100 = 0;

  if(latestScan && latestScan.progressMode){
    const mode = String(latestScan.progressMode);
    if(mode === "fixed"){
      pct100 = clamp(Number(latestScan.progressValue ?? 0), 0, 100);
      label = `Progress: ${pct100}%`;
      barMode = "fixed";
    } else if(mode === "unknown"){
      label = "Progress: ???%";
      barMode = "unknown";
    }
  }

  el("progressPill").textContent = label;
  bar.classList.remove("unknown");
  if(barMode === "unknown"){
    bar.classList.add("unknown");
  } else {
    bar.style.width = `${pct100}%`;
  }
}

function render(d){
  const todayISO = ukISODate();
  const past = scansThatHaveHappened(d);

  el("subtitle").textContent = `Mission: deliver Bing Bong to ${d.friendName || "Pev"}. Birthday: ${niceDate(d.birthdayDate)}.`;
  el("trackingPill").textContent = `Tracking: ${makeTrackingNumber(d)}`;

  el("countdown").textContent = "";

  const latest = past.length > 0 ? past[past.length - 1] : null;
  const stage = stageKeyFromLatestScan(latest);
  const delivered = stage === "delivered";

  // üî• ETA PILL (tweaked):
  // - If Delivered has unlocked: victory line
  // - Else if crash has happened: ??? signal lost
  // - Else: countdown to crash (date-only)
  const crashScan = (Array.isArray(d.scans) ? d.scans : []).find(s => String(s.stageKey) === "crash");
  const crashISO = crashScan ? crashScan.whenISO : null;

  if(delivered){
    el("etaPill").textContent = "ETA: COMPLETED (Bing Bong victorious)";
  } else if(crashISO && todayISO >= crashISO){
    el("etaPill").textContent = "ETA: ??? (signal lost)";
  } else if(crashISO && todayISO < crashISO){
    const t0 = dateFromISO(todayISO);
    const t1 = dateFromISO(crashISO);
    const daysToCrash = Math.max(0, Math.round((t1 - t0) / (1000*60*60*24)));
    el("etaPill").textContent = `ETA: ${daysToCrash} day(s) until incident`;
  } else {
    el("etaPill").textContent = "ETA: Bing Bong-time";
  }

  const preShip = (todayISO < (d.shipmentDate || "0000-00-00"));
  el("statusPill").textContent = `Status: ${delivered ? "Delivered ‚úÖ" : (preShip ? "Preparing for Dispatch" : "In Transit")}`;
  el("statusPill").className = delivered ? "pill ok" : (preShip ? "pill warn" : "pill ok");

  const bday = d.birthdayDate;
  const banner = el("birthdayBanner");
  const pill = el("birthdayPill");

  if(delivered){
    pill.style.display = "none";
    banner.style.display = "none";
  } else {
    if(todayISO === bday){
      pill.style.display = "";
      banner.style.display = "";
      banner.textContent = "üéÇ It‚Äôs Pev‚Äôs birthday TODAY. Bing Bong performed a ceremonial squeak and promised he was basically arriving spiritually.";
    } else {
      pill.style.display = "none";
      banner.style.display = "none";
    }
  }

  if(latest){
    el("currentPlace").textContent = `Latest scan: ${latest.title || "SCAN"}`;
    el("currentMsg").textContent = `${latest.loc || "Unknown"} ‚Äî ${scanDisplayDate(latest)}. ${latest.desc || ""}`;
    applyProgressFromScan(latest);
    renderDailyUpdate(d, stage, todayISO, latest);
  } else {
    el("currentPlace").textContent = "Latest scan: Pending";
    el("currentMsg").textContent = "Bing Bong is currently off-grid, gathering supplies and emotional resilience.";
    el("progressPill").textContent = "Progress: 0%";
    el("bar").classList.remove("unknown");
    el("bar").style.width = "0%";
    renderDailyUpdate(d, "unknown", todayISO, null);
  }

  renderTimeline(past);
}

(async () => {
  try{
    const d = await loadData();
    render(d);
  }catch(e){
    el("subtitle").textContent = "Couldn‚Äôt load data.json üò≠/npm";
    el("currentMsg").textContent = "Make sure data.json exists in the repo root alongside index.html.";
  }
})();
</script>
</body>
</html>
